<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iron-overlay-manager.html">

<script>
  /**
   * `overlay-content` template allows to distribute its content in a `contentParent`.
   * Its main use case is to distribute content into an
   * [`overlay-template`](#overlay-template) when it's hosted in an element's shadow dom.
   *
   * See [`Polymer.IronOverlayHostBehavior`](#Polymer.IronOverlayHostBehavior)
   * for more details.
   *
   * @demo demo/template.html
   */

  Polymer({
    is: 'overlay-content',
    extends: 'template',
    behaviors: [Polymer.Templatizer],
    properties: {
      /**
       * The parent where to stamp the contents.
       */
      contentParent: {
        type: Node,
        observer: '_contentParentChanged'
      }
    },

    created: function() {
      // The stamped instance.
      this._root = null;
      // The instance children; must keep track of these, as on detached we
      // want to bring these back to the instance root.
      this._children = [];
    },

    attached: function() {
      if (this.contentParent) {
        this._contentParentChanged(this.contentParent);
      }
    },

    detached: function() {
      this._ensureDetached();
    },

    /**
     * Stamps the template if needed, and appends its contents to the contentParent.
     * @private
     */
    _contentParentChanged: function() {
      if (!this.isAttached) {
        return;
      }
      if (!this._root) {
        this.templatize(this);
        this._root = this.stamp().root;
      } else {
        // Bring children back to root.
        this._ensureDetached();
      }
      // Store children & append to new content parent.
      this._children = Array.prototype.slice.apply(this._root.children);
      Polymer.dom(this.contentParent).appendChild(this._root);
    },

    /**
     * Brings the children back to the instance root from wherever they were.
     * @private
     */
    _ensureDetached: function() {
      for (var i = 0; i < this._children.length; i++) {
        this._root.appendChild(this._children[i]);
      }
      this._children = [];
    },

    /**
     * Implements extension point from `Polymer.Templatizer`.
     * Forward values to the stamped children.
     */
    _forwardParentProp: function(prop, value) {
      for (var i = 0; i < this._children.length; i++) {
        var inst = this._children[i]._templateInstance;
        // Might be undefined (e.g. for template elements)
        if (inst) {
          inst[prop] = value;
        }
      }
    }
  });
</script>
